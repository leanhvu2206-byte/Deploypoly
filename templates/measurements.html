{% extends "base.html" %}
{% block content %}
  <style>
    /* ====== Bảng tổng thể ====== */
    table.table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      font-variant-numeric: tabular-nums;
      table-layout: auto;
    }
    th, td {
      padding: .55rem .75rem;
      font-size: .95rem;
      vertical-align: top;
      white-space: normal !important;
      word-wrap: break-word;
      line-height: 1.3;
    }
    th { text-align: center; }
    .text-end { text-align: right; }
    .text-muted { color: #6b7280; }

    /* ====== Chips (Actuals & Extras) ====== */
    .chips-col { display: flex; flex-direction: column; gap: .4rem; }
    .extras { display: flex; flex-wrap: wrap; gap: .3rem .5rem; align-items: flex-start; }
    .chip{
      display: inline-flex; align-items: center; gap: .35rem;
      padding: .3rem .55rem; border: 1px solid #e5e7eb; border-radius: 9999px;
      background: #fff; font-size: .83rem; line-height: 1.2; white-space: nowrap;
    }
    .chip__name{ font-weight: 600; }
    .chip__tol{ color: #6b7280; margin-left: .15rem; }
    .chip__badge{
      font-weight: 700; font-size: .75rem; padding: .1rem .45rem; border-radius: 9999px; background: #e5e7eb;
    }
    .chip--pass{ border-color: #a7f3d0; background: #ecfdf5; }
    .chip--fail{ border-color: #fecaca; background: #fef2f2; }

    /* ====== Verdict tổng ====== */
    .pill {
      display: inline-block; padding: .4rem .8rem; border-radius: 9999px;
      font-weight: 700; font-size: .8rem; line-height: 1; color: #fff; text-align: center; min-width: 70px;
      box-shadow: 0 1px 2px rgba(0,0,0,.15);
    }
    .pill--pass { background: linear-gradient(135deg, #16a34a, #22c55e); }
    .pill--fail { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .col-verdict { text-align: center; white-space: nowrap; width: 7rem; }

    /* ====== Cột người đo ====== */
    .who { line-height: 1.25; }
    .who__name { font-weight: 600; }
    .who__area { color: #6b7280; font-size: .85em; }
    .who__note {
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; text-overflow: ellipsis; white-space: normal;
      margin-top: .15rem; font-size: .9em; color: #374151;
    }

    /* ====== Hàng chứa form cập nhật ====== */
    .ca-row { display: none; }
    .ca-row.show { display: table-row; }
    .ca-row > td {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      padding: 1rem;
    }
    .ca-card {
      background: #fff; border: 1px solid #e5e7eb; border-radius: .75rem;
      box-shadow: 0 1px 2px rgba(0,0,0,.06); padding: .75rem;
    }
    .ca-grid { display: grid; gap: .5rem; grid-template-columns: 70px 1fr 180px 160px 150px auto; }
    .ca-grid .form-control, .ca-grid .form-select { height: calc(1.5em + .5rem + 2px); padding: .25rem .5rem; }
    .ca-actions { display:flex; gap:.5rem; align-items:center; }
    .ca-hint { font-size:.8rem; color:#6b7280; }

    /* ====== Preview trong cột Hành động ====== */
    .ca-preview {
      display:flex; flex-direction:column; gap:.2rem; font-size:.85rem; color:#111827;
    }
    .ca-preview small { color:#6b7280; }
    .badge-status{
      display:inline-block; padding:.15rem .5rem; border-radius:9999px; font-weight:600; font-size:.75rem;
      background:#e5e7eb;
    }
    .badge-status[data-s="open"]{ background:#dbeafe; }
    .badge-status[data-s="in_progress"]{ background:#fde68a; }
    .badge-status[data-s="done"]{ background:#bbf7d0; }

    @media (max-width: 1200px) {
      th, td { font-size: .9rem; padding: .45rem .6rem; }
      .extras { gap: .35rem; }
      .ca-grid { grid-template-columns: 60px 1fr 140px 140px 140px auto; }
    }
    @media (max-width: 768px) {
      .ca-grid { grid-template-columns: 1fr; }
    }
  </style>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Tất cả bài đo</h3>
    <a class="btn btn-success" href="{{ url_for('new_measurement') }}">+ Tạo mới</a>
  </div>

  <form class="row g-2 mb-3" method="get">
    <div class="col-auto">
      <input class="form-control" name="q" placeholder="Tìm theo tiêu đề hoặc mã hàng..." value="{{ q or '' }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">Tìm</button>
    </div>
  </form>

  {% macro dim_chip(name, size, tol, actual, verdict) -%}
    {%- set status = verdict -%}
    <span class="chip {{ status==1 and 'chip--pass' or (status==0 and 'chip--fail' or '') }}">
      <span class="chip__name">{{ name }}</span>
      <span class="chip__dim">
        {{ size is not none and size or '—' }}
        {% if tol %}<span class="chip__tol">({{ tol }})</span>{% endif %}
      </span>
      <span class="chip__actual">Actual: {{ actual is not none and actual or '—' }}</span>
      {% if status is not none %}
        <span class="chip__badge">{{ status==1 and 'PASS' or 'FAIL' }}</span>
      {% endif %}
    </span>
  {%- endmacro %}

  <table class="table table-striped table-sm align-middle">
    <colgroup>
      <col style="width:5%">
      <col style="width:10%">
      <col style="width:12%">
      <col style="width:12%">
      <col style="width:12%">
      <col style="width:18%">
      <col>
      <col style="width:16%">
      <col style="width:8%">
      <col style="width:18%"> <!-- tăng 1 chút cho preview -->
      <col style="width:8%">
      <col style="width:6%">
    </colgroup>

    <thead>
      <tr>
        <th class="text-end">ID</th>
        <th>Mã hàng</th>
        <th class="text-center">ID (size/tol)</th>
        <th class="text-center">OD1 (size/tol)</th>
        <th class="text-center">OD2 (size/tol)</th>
        <th class="text-center">Actuals (ID/OD1/OD2)</th>
        <th>Extras</th>
        <th>Người đo / Khu vực / Ghi chú</th>
        <th>Verdict</th>
        <th>Hành động</th>
        <th>Thời gian</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      {% for r in rows %}
        {% set a = r.action %}
        <tr id="m-{{ r.id }}">
          <td class="text-center">{{ r.id }}</td>
          <td>{{ r.item_code or '' }}</td>

          <td class="text-center">
            {{ r.id_size or '—' }} {% if r.id_tol %}({{ r.id_tol }}){% endif %}
          </td>
          <td class="text-center">
            {{ r.od1_size or '—' }} {% if r.od1_tol %}({{ r.od1_tol }}){% endif %}
          </td>
          <td class="text-center">
            {{ r.od2_size or '—' }} {% if r.od2_tol %}({{ r.od2_tol }}){% endif %}
          </td>

          <td class="text-center">
            <div class="chips-col">
              {{ dim_chip('ID',  r.id_size,  r.id_tol,  r.actual_id,  r.verdict_id) }}
              {{ dim_chip('OD1', r.od1_size, r.od1_tol, r.actual_od1, r.verdict_od1) }}
              {{ dim_chip('OD2', r.od2_size, r.od2_tol, r.actual_od2, r.verdict_od2) }}
            </div>
          </td>

          <td>{{ r.extra_checks | render_extras | safe }}</td>

          <td>
            <div class="who">
              <div class="who__name">
                {{ r.measured_by or '—' }}
                {% if r.area %}<span class="who__area"> • {{ r.area }}</span>{% endif %}
              </div>
              {% if r.note %}
                <small class="who__note" title="{{ r.note }}">{{ r.note }}</small>
              {% else %}
                <small class="text-muted">—</small>
              {% endif %}
            </div>
          </td>

          <td class="col-verdict">
            {% if r.verdict_overall is not none %}
              <span class="pill {{ r.verdict_overall and 'pill--pass' or 'pill--fail' }}">
                {{ r.verdict_overall and 'PASS' or 'FAIL' }}
              </span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>

          <!-- Cột Hành động: preview + nút -->
          <td>
            {% if a %}
              <div class="ca-preview mb-2">
                <div><strong>#{{ a.seq_no or '—' }}</strong> • <span>{{ a.action }}</span></div>
                <div>
                  <small>Owner: {{ a.owner or '—' }}</small>
                  &nbsp;•&nbsp;
                  <small>Due: {{ a.due_date and a.due_date.strftime('%Y-%m-%d') or '—' }}</small>
                  &nbsp;•&nbsp;
                  <span class="badge-status" data-s="{{ a.status }}">{{ a.status|replace('_',' ')|title }}</span>
                </div>
              </div>
              <button
                type="button"
                class="btn btn-outline-primary btn-sm ca-toggle"
                data-mid="{{ r.id }}"
                aria-expanded="false">
                Xem chi tiết
              </button>
            {% else %}
              <button
                type="button"
                class="btn btn-outline-primary btn-sm ca-toggle"
                data-mid="{{ r.id }}"
                aria-expanded="false">
                Cập nhật
              </button>
            {% endif %}
          </td>

          <td class="text-muted">{{ r.created_at | fmt_dt }}</td>

          <td>
            <form
              method="post"
              action="{{ url_for('delete_measurement', mid=r.id) }}"
              class="d-inline"
              data-id="{{ r.id }}"
              onsubmit="return askPwdAndConfirm(this);">
              <input type="hidden" name="password" value="">
              <button type="submit" class="btn btn-outline-danger btn-sm">Xoá</button>
            </form>
          </td>
        </tr>

        <!-- Hàng mở rộng chứa form cập nhật -->
        <tr id="carow-{{ r.id }}" class="ca-row">
          <td colspan="12">
            <div class="ca-card">
              <form method="post" action="{{ url_for('upsert_action', mid=r.id) }}">
                <div class="ca-grid">
                  <div>
                    <label class="form-label mb-1">STT</label>
                    <input type="number" name="seq_no" class="form-control form-control-sm" placeholder="#" value="{{ a and a.seq_no or '' }}">
                  </div>

                  <div>
                    <label class="form-label mb-1">Hành động</label>
                    <input name="action" class="form-control form-control-sm" placeholder="Mô tả hành động cần làm" required value="{{ a and a.action or '' }}">
                  </div>

                  <div>
                    <label class="form-label mb-1">Người phụ trách</label>
                    <input name="owner" class="form-control form-control-sm" placeholder="VD: Minh/QA" value="{{ a and a.owner or '' }}">
                  </div>

                  <div>
                    <label class="form-label mb-1">Thời hạn</label>
                    <input type="date" name="due_date" class="form-control form-control-sm"
                           value="{{ a and a.due_date and a.due_date.strftime('%Y-%m-%d') or '' }}">
                  </div>

                  <div>
                    <label class="form-label mb-1">Tình trạng</label>
                    <select name="status" class="form-select form-select-sm">
                      {% set st = a and a.status or 'open' %}
                      <option value="open" {{ 'selected' if st=='open' else '' }}>Open</option>
                      <option value="in_progress" {{ 'selected' if st=='in_progress' else '' }}>In progress</option>
                      <option value="done" {{ 'selected' if st=='done' else '' }}>Done</option>
                    </select>
                  </div>

                  <div class="ca-actions align-self-end">
                    <button class="btn btn-primary btn-sm" type="submit">Lưu</button>
                    <span class="ca-hint">Chỉ mở form khi cần cập nhật</span>
                  </div>
                </div>
              </form>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    // Toggle mở/đóng hàng form cập nhật
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.ca-toggle');
      if (!btn) return;

      const id  = btn.dataset.mid;
      const row = document.getElementById('carow-' + id);

      // Đóng các hàng khác (nếu muốn chỉ mở 1 cái)
      document.querySelectorAll('.ca-row.show').forEach(r => {
        if (r !== row) r.classList.remove('show');
      });
      document.querySelectorAll('.ca-toggle[aria-expanded="true"]').forEach(b => {
        if (b !== btn) {
          b.setAttribute('aria-expanded', 'false');
          // Nếu button đó có preview, giữ nhãn "Xem chi tiết", ngược lại "Cập nhật"
          const hasPreview = !!b.closest('td').querySelector('.ca-preview');
          b.textContent = hasPreview ? 'Xem chi tiết' : 'Cập nhật';
        }
      });

      if (row) {
        const willShow = !row.classList.contains('show');
        row.classList.toggle('show', willShow);
        btn.setAttribute('aria-expanded', willShow ? 'true' : 'false');
        btn.textContent = willShow ? 'Đóng' : (btn.closest('td').querySelector('.ca-preview') ? 'Xem chi tiết' : 'Cập nhật');
        if (willShow) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });

    function askPwdAndConfirm(form) {
      const id  = form.dataset.id;
      const pwd = prompt(`Nhập mật khẩu để xoá bài đo #${id}:`);
      if (!pwd) return false;
      form.querySelector('input[name="password"]').value = pwd;
      return confirm(`Bạn chắc chắn muốn xoá bài đo #${id}?`);
    }
  </script>
{% endblock %}
